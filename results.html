<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Results - AI Research Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-search me-2"></i>AI Research Agent
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/">
                        <i class="fas fa-arrow-left me-1"></i>New Search
                    </a>
                </div>
            </div>
        </nav>

        <div class="container">
            <!-- Research Topic Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h4 class="mb-0">
                                        <i class="fas fa-document-text me-2"></i>
                                        Research Report
                                    </h4>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-light text-primary">
                                        {{ report.total_sources }} sources analyzed
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <h2 class="text-primary mb-3">{{ report.topic }}</h2>
                            <div class="row text-muted">
                                <div class="col-md-6">
                                    <small>
                                        <i class="fas fa-calendar me-1"></i>
                                        Generated: {{ report.timestamp[:19].replace('T', ' ') }}
                                    </small>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <small>
                                        <i class="fas fa-clock me-1"></i>
                                        Session: {{ report.session_id[:8] }}...
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-download me-2"></i>Export Options
                            </h5>
                            <div class="btn-group" role="group">
                                <a href="/export/{{ report.session_id }}/pdf" 
                                   class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-file-pdf me-1"></i>Download PDF
                                </a>
                                <a href="/export/{{ report.session_id }}/markdown" 
                                   class="btn btn-outline-secondary" target="_blank">
                                    <i class="fas fa-file-alt me-1"></i>Download Markdown
                                </a>
                                <button class="btn btn-outline-info" onclick="copyToClipboard()">
                                    <i class="fas fa-copy me-1"></i>Copy Link
                                </button>
                                <button class="btn btn-outline-success" onclick="shareReport()">
                                    <i class="fas fa-share me-1"></i>Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Summary -->
            {% if report.summary %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-file-contract me-2"></i>Executive Summary
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if report.summary.main_summary %}
                                <p class="lead">{{ report.summary.main_summary }}</p>
                            {% endif %}
                            
                            {% if report.summary.method %}
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-cog me-1"></i>
                                        Generated using: {{ report.summary.method.title() }}
                                        {% if report.summary.confidence %}
                                            | Confidence: {{ report.summary.confidence.title() }}
                                        {% endif %}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Key Findings -->
            {% if report.summary and report.summary.key_points %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Key Findings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for point in report.summary.key_points %}
                                <div class="col-lg-6 mb-3">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <span class="badge bg-primary rounded-pill">{{ loop.index }}</span>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <p class="mb-0">{{ point }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Source Analysis Table -->
            {% if report.sources %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Source Analysis
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Source</th>
                                            <th scope="col">Domain</th>
                                            <th scope="col">Date</th>
                                            <th scope="col">Words</th>
                                            <th scope="col">Reliability</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for source in report.sources %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <div class="source-title">
                                                    {{ source.title[:60] }}{% if source.title|length > 60 %}...{% endif %}
                                                </div>
                                                {% if source.authors %}
                                                <small class="text-muted">
                                                    <i class="fas fa-user me-1"></i>
                                                    {{ source.authors|join(', ') }}
                                                </small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark">
                                                    {{ source.domain }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if source.publish_date %}
                                                    {{ source.publish_date[:10] }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if source.word_count %}
                                                    {{ source.word_count }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% set reliability = 'Medium' %}
                                                {% for citation in report.citations %}
                                                    {% if citation.url == source.url %}
                                                        {% if citation.reliability_score >= 0.8 %}
                                                            {% set reliability = 'High' %}
                                                        {% elif citation.reliability_score >= 0.6 %}
                                                            {% set reliability = 'Medium' %}
                                                        {% else %}
                                                            {% set reliability = 'Low' %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if reliability == 'High' %}
                                                    <span class="badge bg-success">High</span>
                                                {% elif reliability == 'Medium' %}
                                                    <span class="badge bg-warning">Medium</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Low</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ source.url }}" target="_blank" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </a>
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#sourceModal{{ loop.index }}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Citations -->
            {% if report.citations %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-quote-right me-2"></i>Bibliography
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="citations-list">
                                {% for citation in report.citations %}
                                <div class="citation-item mb-3 p-3 border-start border-primary border-3">
                                    <div class="citation-number fw-bold text-primary mb-1">
                                        [{{ citation.index }}]
                                    </div>
                                    <div class="citation-text">
                                        {{ citation.formatted }}
                                    </div>
                                    {% if citation.reliability_score %}
                                    <div class="citation-meta mt-2">
                                        <small class="text-muted">
                                            Reliability Score: {{ "%.1f"|format(citation.reliability_score * 100) }}%
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Research Quality Metrics -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Research Quality Metrics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="text-center">
                                        <div class="h3 text-primary">{{ report.total_sources }}</div>
                                        <div class="text-muted">Sources Analyzed</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="text-center">
                                        <div class="h3 text-success">
                                            {% set total_words = report.sources|sum(attribute='word_count')|default(0) %}
                                            {{ total_words }}
                                        </div>
                                        <div class="text-muted">Total Words</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="text-center">
                                        <div class="h3 text-warning">
                                            {% set avg_reliability = (report.citations|sum(attribute='reliability_score')/report.citations|length*100)|round|int if report.citations else 0 %}
                                            {{ avg_reliability }}%
                                        </div>
                                        <div class="text-muted">Avg. Reliability</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="text-center">
                                        <div class="h3 text-info">
                                            {% set unique_domains = report.sources|map(attribute='domain')|unique|list|length %}
                                            {{ unique_domains }}
                                        </div>
                                        <div class="text-muted">Unique Domains</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Source Detail Modals -->
        {% for source in report.sources %}
        <div class="modal fade" id="sourceModal{{ loop.index }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ source.title }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>URL:</strong> 
                            <a href="{{ source.url }}" target="_blank">{{ source.url }}</a>
                        </div>
                        {% if source.authors %}
                        <div class="mb-3">
                            <strong>Authors:</strong> {{ source.authors|join(', ') }}
                        </div>
                        {% endif %}
                        {% if source.publish_date %}
                        <div class="mb-3">
                            <strong>Published:</strong> {{ source.publish_date }}
                        </div>
                        {% endif %}
                        {% if source.summary %}
                        <div class="mb-3">
                            <strong>Summary:</strong>
                            <p>{{ source.summary }}</p>
                        </div>
                        {% endif %}
                        {% if source.text %}
                        <div class="mb-3">
                            <strong>Content Preview:</strong>
                            <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                {{ source.text[:1000] }}{% if source.text|length > 1000 %}...{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <a href="{{ source.url }}" target="_blank" class="btn btn-primary">
                            Visit Source <i class="fas fa-external-link-alt ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Footer -->
        <footer class="bg-dark text-white mt-5 py-4">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <h5>AI Research Agent</h5>
                        <p class="mb-0">Intelligent research assistance powered by AI</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p class="mb-0">
                            <small>Report generated on {{ report.timestamp[:19].replace('T', ' ') }}</small>
                        </p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyToClipboard() {
            navigator.clipboard.writeText(window.location.href).then(function() {
                alert('Link copied to clipboard!');
            });
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: 'Research Report: {{ report.topic }}',
                    text: 'Check out this AI-generated research report',
                    url: window.location.href
                });
            } else {
                copyToClipboard();
            }
        }
    </script>
</body>
</html>